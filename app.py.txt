import streamlit as st
import json
import os
import pandas as pd

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="ì¦ê¶Œ ì†ë³´ ëª¨ë‹ˆí„°ë§", layout="wide")

# 1. ì œì™¸ í‚¤ì›Œë“œ ë¡œë“œ (ì—‘ì…€ íŒŒì¼)
def get_exclude_list():
    exclude_file = 'exclude.xlsx'
    if os.path.exists(exclude_file):
        try:
            df = pd.read_excel(exclude_file)
            return df.iloc[:, 0].dropna().astype(str).tolist()
        except:
            return []
    return []

# 2. ë©”ì¸ UI ë° ê²€ìƒ‰ë°”
st.title("ğŸ—ï¸ ì‹¤ì‹œê°„ ì¦ê¶Œ ë‰´ìŠ¤ í”¼ë“œ")
search_term = st.sidebar.text_input("ğŸ” ì œëª© í‚¤ì›Œë“œ ê²€ìƒ‰", "")

# 3. ë°ì´í„° í‘œì‹œ
if os.path.exists('news.json'):
    with open('news.json', 'r', encoding='utf-8') as f:
        news_data = json.load(f)
    
    exclude_list = get_exclude_list()
    st.sidebar.write(f"í˜„ì¬ ì ìš©ëœ ì œì™¸ í‚¤ì›Œë“œ: {len(exclude_list)}ê°œ")
    
    count = 0
    for news in news_data:
        # í•„í„°ë§ 1: ì œì™¸ í‚¤ì›Œë“œ ì²˜ë¦¬
        if any(key.lower() in news['title'].lower() for key in exclude_list if key):
            continue
            
        # í•„í„°ë§ 2: ê²€ìƒ‰ì–´ ì²˜ë¦¬
        if search_term and search_term.lower() not in news['title'].lower():
            continue
            
        # ë‰´ìŠ¤ ì¶œë ¥ (ì œëª© / ë°œí–‰ì¼ì‹œ í˜•íƒœ)
        # ì œëª©ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ë§í¬ë¡œ ì´ë™
        st.markdown(f"**[{news['title']}]({news['link']})** &nbsp;&nbsp; <small style='color:gray;'>{news['pub_time']}</small>", unsafe_allow_html=True)
        st.divider()
        count += 1
    
    if count == 0:
        st.write("í‘œì‹œí•  ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.")
else:
    st.warning("ì•„ì§ ìˆ˜ì§‘ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” (10ë¶„ ì£¼ê¸°).")